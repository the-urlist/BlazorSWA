@using System.Text.Json
@using BlazorApp.Shared

@inject NavigationManager NavigationManager
@inject StateContainer StateContainer
@inject HttpClient Http

<ModalWindow @ref="modal">

  <div>
    <p>Import any lists you created under a Twitter login.</p>
    <a href="@($"{migrationSiteUrl}?newUsername={StateContainer.User?.ClientPrincipal?.UserDetails}&newIdentityProvider={StateContainer.User?.ClientPrincipal?.IdentityProvider}&id={migrationId}")"
      class="button mt-4">Import From Twitter</a>
  </div>

</ModalWindow>

@code {
  ModalWindow? modal;

  private string? userData;
  private string? migrationId;
  private string? migrationSiteUrl;

  // on init async
  protected override void OnInitialized()
  {
    var data = new
    {
      userDetails = StateContainer.User?.ClientPrincipal.UserDetails,
      identityProvider = StateContainer.User?.ClientPrincipal.IdentityProvider
    };

    userData = JsonSerializer.Serialize(data);
  }

  public async void Show()
  {
    var migrationInfo = await GetMigrationInfo();
    migrationId = migrationInfo.Migration.Id;
    migrationSiteUrl = migrationInfo.MigrationSiteURL;
    modal?.ShowModal();
  }

  public async Task<MigrationWrapper> GetMigrationInfo()
  {
    var response = await Http.GetAsync("api/migration");
    var migration = await response.Content.ReadFromJsonAsync<MigrationWrapper>() ?? new MigrationWrapper();

    return migration;
  }
}